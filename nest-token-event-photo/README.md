# NestJS API: Authentication & S3 Image Uploads

<p align="center">
  <img src="https://img.shields.io/badge/nestjs-%23E0234E.svg?style=for-the-badge&logo=nestjs&logoColor=white" alt="NestJS">
  <img src="https://img.shields.io/badge/MongoDB-%2347A248.svg?style=for-the-badge&logo=mongodb&logoColor=white" alt="MongoDB">
  <img src="https://img.shields.io/badge/docker-%230db7ed.svg?style=for-the-badge&logo=docker&logoColor=white" alt="Docker">
  <img src="https://img.shields.io/badge/AWS S3-%23569A31.svg?style=for-the-badge&logo=amazon-s3&logoColor=white" alt="AWS S3">
  <img src="https://img.shields.io/badge/typescript-%23007ACC.svg?style=for-the-badge&logo=typescript&logoColor=white" alt="TypeScript">
</p>

---

## üìñ Sobre o Projeto / About The Project

<details>
<summary><strong>üáßüá∑ Descri√ß√£o em Portugu√™s</strong></summary>
<br>
Este √© um projeto backend robusto constru√≠do com <strong>NestJS</strong>, projetado para servir como uma base s√≥lida e segura para aplica√ß√µes modernas. A arquitetura implementa um sistema de autentica√ß√£o de ponta a ponta com <strong>Access Tokens (JWT)</strong> e <strong>Refresh Tokens criptografados (JWE)</strong>, garantindo m√°xima seguran√ßa e uma excelente experi√™ncia de usu√°rio atrav√©s de rota√ß√£o de tokens.

O projeto inclui um servi√ßo desacoplado para upload e streaming de imagens para um bucket <strong>AWS S3</strong> (simulado localmente com <strong>LocalStack</strong>), com gerenciamento de metadados em um banco de dados <strong>MongoDB</strong>. Toda a infraestrutura (aplica√ß√£o, banco de dados e servi√ßos AWS) √© orquestrada com <strong>Docker</strong> e <strong>Docker Compose</strong>, permitindo que o ambiente de desenvolvimento completo seja iniciado com um √∫nico comando.
</details>

<details>
<summary><strong>üá¨üáß English Description</strong></summary>
<br>
This is a robust backend project built with <strong>NestJS</strong>, designed to serve as a solid and secure foundation for modern applications. The architecture implements an end-to-end authentication system featuring <strong>Access Tokens (JWT)</strong> and <strong>encrypted Refresh Tokens (JWE)</strong>, ensuring maximum security and a great user experience through token rotation.

The project includes a decoupled service for uploading and streaming images to an <strong>AWS S3</strong> bucket (simulated locally with <strong>LocalStack</strong>), with metadata management in a <strong>MongoDB</strong> database. The entire infrastructure (application, database, and AWS services) is orchestrated with <strong>Docker</strong> and <strong>Docker Compose</strong>, allowing the complete development environment to be started with a single command.
</details>

---

## ‚ú® Funcionalidades Principais / Key Features

<details>
<summary><strong>üáßüá∑ Detalhes das Funcionalidades</strong></summary>
<br>

-   #### **Autentica√ß√£o e Autoriza√ß√£o Avan√ßadas**:
    -   **Access Tokens (JWT)**: Tokens de curta dura√ß√£o (`15m`) para autenticar requisi√ß√µes.
    -   **Refresh Tokens (JWE)**: Tokens de longa dura√ß√£o (`7d`) e criptografados (JSON Web Encryption) para proteger seu conte√∫do, aumentando a seguran√ßa.
    -   **Armazenamento Seguro de Tokens**: Utiliza cookies `HttpOnly`, `Secure`, e `SameSite=Strict` para mitigar riscos de XSS.
    -   **Rota√ß√£o de Tokens (Token Rotation)**: A cada requisi√ß√£o de `refresh`, o refresh token antigo √© invalidado e um novo par de tokens √© emitido, prevenindo o reuso de tokens roubados.
    -   **Logout Seguro no Servidor**: A invalida√ß√£o do refresh token ocorre no banco de dados, garantindo que a sess√£o seja terminada de forma definitiva.
    -   **Controle de Acesso por Papel (RBAC)**: Prote√ß√£o de rotas com o decorador `@Roles` e um `RolesGuard` customizado, permitindo permiss√µes granulares (`admin`, `user`).
    -   **Hashing de Senhas**: Utiliza `bcrypt` para armazenar senhas de forma segura, prevenindo ataques de rainbow table.

-   #### **Gerenciamento de Imagens Desacoplado e Perform√°tico**:
    -   **Upload de Imagens (Base64)**: Endpoint simplificado que aceita imagens em formato base64.
    -   **Integra√ß√£o com AWS S3**: Armazena arquivos de forma desacoplada em um bucket S3 (simulado com **LocalStack**).
    -   **Recupera√ß√£o de Imagens**: As imagens s√£o lidas via fluxo e retornadas como strings codificadas em base64 usando a interface `Base64ImageResponse`. Essa abordagem minimiza o uso de mem√≥ria do servidor, tornando-a ideal para lidar com arquivos grandes de forma eficiente.
    -   **Opera√ß√µes Resilientes**: Implementa l√≥gica de retentativas para uploads e downloads do S3, lidando com falhas transit√≥rias de rede ou servi√ßo.

-   #### **Pr√°ticas de Seguran√ßa Robustas**:
    -   **Prote√ß√£o contra CSRF**: Middleware (`CsrfMiddleware`) implementa o padr√£o *Double Submit Cookie* para proteger todas as rotas que alteram estado.
    -   **Sanitiza√ß√£o de Inputs**: Um `SanitizeInputInterceptor` global remove tags HTML de todos os inputs do corpo da requisi√ß√£o para prevenir ataques de XSS e inje√ß√£o de HTML.
    -   **Rate Limiting (Throttling)**: Protege a API contra ataques de for√ßa bruta e nega√ß√£o de servi√ßo, limitando o n√∫mero de requisi√ß√µes por IP.
    -   **Valida√ß√£o de Dados**: Garante a integridade e o formato dos dados de entrada com `class-validator` e DTOs, rejeitando payloads malformados.
    -   **Cabe√ßalhos de Seguran√ßa**: Utiliza `helmet` para configurar cabe√ßalhos HTTP seguros (CSP, X-Frame-Options, etc.).

</details>

<details>
<summary><strong>üá¨üáß Feature Details</strong></summary>
<br>

-   #### **Advanced Authentication & Authorization**:
    -   **JWT Access Tokens**: Short-lived tokens (`15m`) for authenticating requests.
    -   **JWE Refresh Tokens**: Long-lived (`7d`), encrypted (JSON Web Encryption) tokens to protect their content, enhancing security.
    -   **Secure Token Storage**: Uses `HttpOnly`, `Secure`, and `SameSite=Strict` cookies to mitigate XSS risks.
    -   **Token Rotation**: Upon each `refresh` request, the old refresh token is invalidated, and a new token pair is issued, preventing the reuse of stolen tokens.
    -   **Secure Server-Side Logout**: Invalidation of the refresh token occurs in the database, ensuring the session is terminated definitively.
    -   **Role-Based Access Control (RBAC)**: Protects routes using a custom `@Roles` decorator and a `RolesGuard`, allowing for granular permissions (`admin`, `user`).
    -   **Password Hashing**: Uses `bcrypt` to securely store passwords, preventing rainbow table attacks.

-   #### **Decoupled and Performant Image Management**:
    -   **Base64 Image Upload**: A simplified endpoint that accepts images in base64 format.
    -   **AWS S3 Integration**: Stores files in a decoupled manner in an S3 bucket (simulated with **LocalStack**).
    - **Image Retrieval**: Images are read via stream and returned as base64-encoded strings using the `Base64ImageResponse` interface. This approach minimizes server memory usage, making it ideal for handling large files efficiently.
    -   **Resilient Operations**: Implements retry logic for S3 uploads and downloads to handle transient network or service failures.

-   #### **Robust Security Practices**:
    -   **CSRF Protection**: A `CsrfMiddleware` implements the *Double Submit Cookie* pattern to protect all state-changing routes.
    -   **Input Sanitization**: A global `SanitizeInputInterceptor` strips HTML tags from all request body inputs to prevent XSS and HTML injection attacks.
    -   **Rate Limiting (Throttling)**: Protects the API against brute-force and denial-of-service attacks by limiting the number of requests per IP.
    -   **Data Validation**: Ensures the integrity and format of incoming data with `class-validator` and DTOs, rejecting malformed payloads.
    -   **Security Headers**: Uses `helmet` to configure secure HTTP headers (CSP, X-Frame-Options, etc.).

</details>

---

## üõ†Ô∏è Tecnologias Utilizadas / Tech Stack

| Categoria / Category | Tecnologia / Technology                                                                                                                              |
| -------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Backend**          | [NestJS](https://nestjs.com/), [TypeScript](https://www.typescriptlang.org/)                                                                          |
| **Banco de Dados**   | [MongoDB](https://www.mongodb.com/) com [Mongoose](https://mongoosejs.com/)                                                                            |
| **Autentica√ß√£o**     | [JWT](https://jwt.io/) (`@nestjs/jwt`), [JWE](https://github.com/panva/jose) (`jose`), [CSRF](https://github.com/Psifi-Solutions/csrf-csrf) (`csrf-csrf`) |
| **Armazenamento**    | [AWS S3](https://aws.amazon.com/s3/) (simulado com [LocalStack](https://localstack.cloud/))                                                          |
| **Containeriza√ß√£o**  | [Docker](https://www.docker.com/), [Docker Compose](https://docs.docker.com/compose/)                                                               |
| **Seguran√ßa**        | `bcrypt`, `helmet`, `nestjs-throttler`, `sanitize-html`                                                                                               |
| **Valida√ß√£o**        | `class-validator`, `class-transformer`                                                                                                               |

---

## üöÄ Como Executar / Getting Started

### Pr√©-requisitos / Prerequisites

-   [Docker](https://www.docker.com/get-started) instalado e em execu√ß√£o.
-   [Docker Compose](https://docs.docker.com/compose/install/) instalado.

### Passos para Instala√ß√£o / Installation Steps

1.  **Clone o reposit√≥rio / Clone the repository:**
    ```sh
    git clone https://github.com/token-event-challenge/nest-token-event-photo.git
    cd nest-token-event-photo
    ```

2.  **Crie o arquivo de ambiente / Create the environment file:**
    -   O `.env` fornecido no reposit√≥rio j√° est√° configurado para o ambiente Docker. Se ele n√£o existir, copie o exemplo:
        ```sh
        # Se o arquivo .env n√£o existir / If the .env file does not exist
        cp .env.example .env
        ```
    -   **Importante**: Para um ambiente de produ√ß√£o, √© **crucial** substituir `JWT_SECRET`, `JWE_SECRET` e `CSRF_SECRET` por valores longos, seguros e aleat√≥rios gerados criptograficamente.
    -   **Important**: For a production environment, you **must** replace `JWT_SECRET`, `JWE_SECRET`, and `CSRF_SECRET` with long, secure, cryptographically-generated random values.

3.  **Inicie os servi√ßos com Docker Compose / Start the services with Docker Compose:**
    -   Execute o comando a seguir na raiz do projeto. Ele ir√° construir a imagem da aplica√ß√£o e iniciar todos os cont√™ineres.
        ```sh
        docker-compose up --build
        ```

4.  **Pronto! / You're all set!**
    -   A API estar√° dispon√≠vel em: `http://localhost:3001`
    -   O servi√ßo S3 (LocalStack) estar√° em: `http://localhost:4566`
    -   O MongoDB estar√° em: `mongodb://localhost:27017`

---

## üîë Vari√°veis de Ambiente / Environment Variables

<details>
<summary>Expandir para ver detalhes / Expand to see details</summary>
<br>

| Vari√°vel / Variable             | Descri√ß√£o / Description                                                                                             | Valor Padr√£o no `.env` / Default Value in `.env` |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| `MONGODB_URI`                   | üáßüá∑ URI de conex√£o com o MongoDB. <br/> üá¨üáß MongoDB connection URI.                                                   | `mongodb://mongodb:27017/nextlab`                |
| `JWT_SECRET`                    | **üáßüá∑ (CR√çTICO)** Segredo para assinar tokens JWT. <br/> **üá¨üáß (CRITICAL)** Secret for signing JWTs.                     | `(A long random hex string)`                     |
| `JWE_SECRET`                    | **üáßüá∑ (CR√çTICO)** Segredo para criptografar tokens JWE. <br/> **üá¨üáß (CRITICAL)** Secret for encrypting JWEs.            | `test145820`                                     |
| `CSRF_SECRET`                   | **üáßüá∑ (CR√çTICO)** Segredo para prote√ß√£o CSRF. <br/> **üá¨üáß (CRITICAL)** Secret for CSRF protection.                       | `test14582082`                                   |
| `JWT_EXPIRES_IN`                | üáßüá∑ Tempo de expira√ß√£o do Access Token (formato `ms`). <br/> üá¨üáß Access Token expiration time (`ms` format).           | `15m`                                            |
| `REFRESH_TOKEN_EXPIRES_IN`      | üáßüá∑ Tempo de expira√ß√£o do Refresh Token (formato `ms`). <br/> üá¨üáß Refresh Token expiration time (`ms` format).        | `7d`                                             |
| `JWT_EXPIRES_IN_MS`             | üáßüá∑ Expira√ß√£o do Access Token em milissegundos. <br/> üá¨üáß Access Token expiration in milliseconds.                     | `900000`                                         |
| `REFRESH_TOKEN_EXPIRES_IN_MS`   | üáßüá∑ Expira√ß√£o do Refresh Token em milissegundos. <br/> üá¨üáß Refresh Token expiration in milliseconds.                   | `604800000`                                      |
| `S3_ENDPOINT`                   | üáßüá∑ Endpoint do servi√ßo S3 (LocalStack). <br/> üá¨üáß S3 service endpoint (LocalStack).                                   | `http://localstack:4566`                         |
| `S3_BUCKET`                     | üáßüá∑ Nome do bucket S3 para armazenar imagens. <br/> üá¨üáß Name of the S3 bucket to store images.                           | `image-bucket`                                   |
| `PORT`                          | üáßüá∑ Porta onde a aplica√ß√£o NestJS ir√° rodar. <br/> üá¨üáß Port on which the NestJS application will run.                 | `3001`                                           |
| `API_FRONT_END`                 | üáßüá∑ URL do front-end para configura√ß√£o de CORS. <br/> üá¨üáß Front-end URL for CORS configuration.                         | `http://localhost:3000`                          |

</details>

---

## ‚ÜîÔ∏è Endpoints da API / API Endpoints

<details>
<summary>Ver Endpoints / Show Endpoints</summary>
<br>

### Autentica√ß√£o / Authentication (`/auth`)

| M√©todo / Method | Rota / Route     | Descri√ß√£o / Description                                                                                                    | Prote√ß√£o / Protection               |
| :-------------- | :--------------- | :------------------------------------------------------------------------------------------------------------------------- | :---------------------------------- |
| `POST`          | `/register`      | üáßüá∑ Registra um novo usu√°rio. <br/> üá¨üáß Registers a new user.                                                                  | CSRF                                |
| `POST`          | `/login`         | üáßüá∑ Autentica um usu√°rio e retorna tokens. <br/> üá¨üáß Authenticates a user and returns tokens.                                     | CSRF                                |
| `POST`          | `/refresh`       | üáßüá∑ Gera novos tokens usando o refresh token do cookie. <br/> üá¨üáß Issues new tokens using the refresh token from the cookie.        | CSRF                                |
| `POST`          | `/logout`        | üáßüá∑ Desloga o usu√°rio invalidando o refresh token. <br/> üá¨üáß Logs out the user by invalidating the refresh token.                  | CSRF                                |
| `POST`          | `/password`      | üáßüá∑ Atualiza a senha do usu√°rio autenticado. <br/> üá¨üáß Updates the authenticated user's password.                                  | CSRF + JWT (User/Admin)             |
| `GET`           | `/admin`         | üáßüá∑ Rota de exemplo para acesso de administrador. <br/> üá¨üáß Example route for administrator-only access.                             | JWT (Admin Only)                    |

### Imagem / Image (`/image`)

| M√©todo / Method | Rota / Route          | Descri√ß√£o / Description                                                                                                | Prote√ß√£o / Protection |
| :-------------- | :-------------------- | :--------------------------------------------------------------------------------------------------------------------- | :-------------------- |
| `POST`          | `/image`              | üáßüá∑ Salva uma imagem (base64) no S3. <br/> üá¨üáß Saves an image (base64) to S3.                                              | P√∫blico / Public      |
| `GET`           | `/image/qr/:qrCodeId` | üáßüá∑ Recupera uma imagem pelo seu `qrCodeId` como um stream. <br/> üá¨üáß Retrieves an image by its `qrCodeId` as a stream.        | P√∫blico / Public      |

</details>
